{% load static %}
<div class="filter-card collapse width" id="filter-container">
    <div class="card">
        <form id="filter-form" class="search-form mt-1">
            <a href="#" class="d-none d-lg-inline position-absolute filter-hide-button"
               data-toggle="collapse"
               data-target="#filter-container"
               aria-expanded="false"
               aria-controls="filter-container">Hide
            </a>


            <a href="#" class="position-absolute d-lg-none d-inline-block filter-back-button"
               data-toggle="collapse"
               data-target="#filter-container"
               aria-expanded="false"
               aria-controls="filter-container"
               id="filter-button-submit">
                <i class="fas fa-2x fa-arrow-left"></i>
            </a>

            <div class="clear card-body border-bottom pb-0 pt-lg-1 pt-2 mt-lg-2 mt-3">
                <h4 class="card-title text-center">Filters</h4>
            </div>


            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <label for="authors-input">
                            <strong>Authors</strong>
                        </label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <input id="authors-input" name="authors" class="tagify--outside"
                               placeholder="Author name">
                        <div class="text-muted small">If no author is selected the value defaults to all.</div>
                    </div>
                </div>

                <div class="row mt-1">
                    <div class="col-12">
                        <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
                            <label class="btn btn-light active">
                                <input type="radio" data-no-url="true" name="authors-connection" checked="checked"
                                       data-default="true"
                                       value="one"/> One matching
                            </label>
                            <label class="btn btn-light">
                                <input type="radio" data-no-url="false" name="authors-connection" value="all"/> All
                                matching
                            </label>

                        </div>
                        <div class="text-muted small">Decide whether some or all people should be author of the paper.
                        </div>

                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <label for="journals-input">
                            <strong>Journals</strong>
                        </label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <input id="journals-input" name="journals" class="tagify--outside"
                               placeholder="Journal name">
                        <div class="text-muted small">If no journal is selected the value defaults to all.</div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <strong>Categories</strong>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 text-dark pt-1">
                        {% for category in form.categories.all %}
                            <label class="mb-0 d-lg-block">
                                <input class="mr-1" type="checkbox"
                                       {% if category.pk in form.selected_categories %}checked="checked"{% endif %}
                                       name="categories"
                                       value="{{ category.pk }}">
                                {{ category.name }} <span class="small text-muted">({{ category.papers.count }})</span>
                            </label>

                        {% endfor %}
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <label for="start-date">
                            <strong>Published After</strong>
                        </label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <input autocomplete="off" name="published_at_start" id="start-date"
                               value="{{ form.start_date }}"/>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <label for="start-date">
                            <strong>Published Before</strong>
                        </label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <input autocomplete="off" name="published_at_end" id="end-date" value="{{ form.end_date }}"/>
                    </div>
                </div>


                <div class="row mt-3 d-none d-lg-block">
                    <div class="col-12 text-right">
                        <button id="filter-form-submit" type="submit" class="btn btn-success" disabled><i
                                class="fas fa-sync"></i>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

        </form>

    </div>
</div>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {

        var inputElm = document.getElementById('authors-input');
        var initialValues = JSON.parse('{{ form.authors|escapejs }}');

        var tagify = new Tagify(inputElm, {
            originalInputValueFormat: valuesArr => valuesArr.map(item => item.pk).join(','),
            whitelist: initialValues,
            enforceWhitelist: true,
            skipInvalid: true,
            delimiters: 'a^',
        });

        tagify.addTags(initialValues);

        window.pendingAuthorRequest = null;

        var getAuthors = (function getAuthors(text, on_result) {

            if (window.pendingAuthorRequest) {
                window.pendingAuthorRequest.abort();
            }

            window.pendingAuthorRequest = $.ajax({
                url: "{% url "get-authors" %}",
                type: 'GET',
                data: "query=" + text,
                success: function (data) {
                    on_result(data);
                },
                error: function (request, error) {
                    console.log("Request: " + JSON.stringify(request));
                    console.log("Error: " + error);
                }
            });

        });


        // on character(s) added/removed (user is typing/deleting)
        function onInput(e) {
            tagify.settings.whitelist.length = 0; // reset current whitelist
            tagify.loading(true).dropdown.hide.call(tagify);// show the loader animation

            getAuthors(e.detail.value, function (result) {

                $.each(result.authors, function () {
                    tagify.settings.whitelist.push(this);
                });

                tagify.loading(false).dropdown.show.call(tagify, e.detail.value);
            });
        }

        tagify.on('input', onInput);

    });
</script>

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {

        var inputElm = document.getElementById('journals-input');
        var initialValues = JSON.parse('{{ form.journals|escapejs }}');

        var tagify = new Tagify(inputElm, {
            whitelist: initialValues,
            enforceWhitelist: true,
            skipInvalid: true,
            delimiters: 'a^',
            originalInputValueFormat: valuesArr => valuesArr.map(item => item.pk).join(','),
            dropdown: {
                enabled: 0,
                mapValueTo: data => data.value + " (" + data.count + ")"
            }
        });

        tagify.addTags(initialValues);

        window.pendingAuthorRequest = null;

        var getAuthors = (function getAuthors(text, on_result) {

            if (window.pendingAuthorRequest) {
                window.pendingAuthorRequest.abort();
            }

            window.pendingAuthorRequest = $.ajax({
                url: "{% url "get-journals" %}",
                type: 'GET',
                data: "query=" + text,
                success: function (data) {
                    on_result(data);
                },
                error: function (request, error) {
                    console.log("Request: " + JSON.stringify(request));
                    console.log("Error: " + error);
                }
            });

        });


        // on character(s) added/removed (user is typing/deleting)
        function onInput(e) {
            tagify.settings.whitelist.length = 0; // reset current whitelist
            tagify.loading(true).dropdown.hide.call(tagify);// show the loader animation

            getAuthors(e.detail.value, function (result) {

                $.each(result.journals, function () {
                    tagify.settings.whitelist.push(this);
                });

                tagify.loading(false).dropdown.show.call(tagify, e.detail.value);
            });
        }

        tagify.on('input', onInput);

    });
</script>

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        window.formAjaxAllowed = true;

        let indicator = $("#{{ indicator_id }}");
        let paper_container = $("#{{ result_container_id }}");
        let form = $("#paper-search-form");
        let filter_form = $("#filter-form");
        let pagination_container = $("#pagination-container");

        $("#filter-button-submit").click(function (e) {
            filter_form.submit();
        });

        update_pagination_container = pagination_container.paginate({
            searchQuery: search_query,
        });

        function search_query(data, page, scroll = false, on_success) {
            paper_container.hide();
            indicator.show();

            data += "&page=" + page;

            $.ajax({
                url: form.attr("action"),
                type: 'POST',
                data: data,
                success: function (data) {
                    paper_container.html(data);

                    indicator.hide();
                    paper_container.fadeIn();

                    update_pagination_container();

                    if (scroll) {
                        $('html, body').scrollTop(paper_container.offset().top - 50);
                    }

                    if (on_success) {
                        on_success();
                    }
                },
                error: function (request, error) {
                    console.log("Request: " + JSON.stringify(request));
                    console.log("Error: " + error);
                }
            });
        }


        $('#start-date').datepicker({
            uiLibrary: 'bootstrap4',
            format: 'yyyy-mm-dd'
        }).parent().find('button').removeClass('btn-outline-secondary').addClass('btn-light');

        $('#end-date').datepicker({
            uiLibrary: 'bootstrap4',
            format: 'yyyy-mm-dd'
        }).parent().find('button').removeClass('btn-outline-secondary').addClass('btn-light');

        filter_form.find("input").change(function (e) {
            $("#filter-form-submit").prop("disabled", false)
        });

        filter_form.submit(function (e) {
            e.preventDefault();

            $("#filter-form-submit").prop("disabled", true)
            form.submit();
        });


        form.submit(function (e) {
            e.preventDefault();

            if (!window.formAjaxAllowed) {
                return;
            }

            window.formAjaxAllowed = false;
            $('.nav-search-types label.nav-link').addClass('disabled');

            pagination_container.hide();

            let submission_data = $(".search-form input[data-no-url!=true]").serialize();
            let csrf_token = $('.search-form input[data-no-url=true]').serialize();
            let full_data = submission_data + "&" + csrf_token;

            search_query(full_data, 1, false, function () {
                window.Pagination.last_request = full_data;

                let shortened_data = submission_data.replace(/[^&]+=\.?(?:&|$)/g, '').replace(/&$/, '');

                let url = window.location.protocol + "//" + window.location.host + window.location.pathname;
                if (shortened_data.length > 0) {
                    url += "?" + shortened_data;
                }

                window.history.pushState({path: url}, '', url);


                window.formAjaxAllowed = true;

                $('.nav-search-types label.nav-link').removeClass('disabled');
            });
        });

        {% if load_default %}
            form.submit();
        {% endif %}
    });
</script>
