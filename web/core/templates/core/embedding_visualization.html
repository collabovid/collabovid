{% extends "core/base.html" %}
{% load static %}
{% load pipeline %}
{% load paper_card_extras %}

{% block content %}
    <div class="gradient-header pb-0 overflow-hidden">
        <div class="row mx-0 px-0">
            <div class="col-12 canvas-adaptive-height px-0">
                <div class="canvas-adaptive-height">
                    <div id="canvas-container">
                        <canvas id="visualization-container"></canvas>
                    </div>
                </div>
                <div class="sidebar">
                    <div class="badges">
                        <div class="legend">
                            <div id="category-legend">
                                {% for category in categories %}
                                    <div class="category-label" data-category="{{ category.name }}">
                                        <span class="badge badge-primary"
                                              style="background-color: {{ category.color }}">{{ category.name }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                            <div id="topic-legend" style="display: none">
                                <div>
                                    <span id="topic-label" class="badge badge-light"></span>
                                </div>
                            </div>
                            <div id="paper-selected-legend" style="display: none">
                                <div>
                                    <span class="badge badge-primary"
                                          style="background-color: #ffc266">
                                        Selected Paper
                                    </span>
                                </div>
                                <div>
                                    <span class="badge badge-primary"
                                          style="background-color: #cc7a00">
                                        Most similar papers
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-2 controls text-white d-none d-md-block">
                            <div>
                                <div class="">Zoom Speed</div>
                                <input id="zoom-slider" class="slider" type="text" data-slider-min="0.01"
                                       data-slider-max="1" data-slider-step="0.01" data-slider-value="0.25"/>
                            </div>
                            <div class="mt-2">
                                <div class="">Pan Speed</div>
                                <input id="pan-slider" class="slider" type="text" data-slider-min="0.01"
                                       data-slider-max="1" data-slider-step="0.01" data-slider-value="0.5"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% include 'core/partials/_rounded_bottom.html' %}
    </div>
    <div id="paper-loading-indicator"
         class="text-muted text-center fa-5x my-5"
         style="display: none;">
        <i class="fas fa-circle-notch fa-spin"></i>
    </div>
    <div class="container mt-5">
        <div id="selected-card-container"></div>
    </div>
    <div class="pl-5 pr-5">
        <div id="topics-container" class="d-flex flex-row">
            <div>
                <div id="description-container" class="collapse width position-relative"
                     style="width: auto; height: auto; overflow: hidden">
                    <div class="card" style="width: 500px;">
                        <button type="button" class="btn btn-outline-secondary position-absolute mr-2 mt-2"
                                style="right: 0;" data-toggle="collapse"
                                data-target="#description-container"
                                aria-expanded="true"
                                aria-controls="description-container">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="card-body">
                            <h4 class="card-title">Research Landscape Visualization</h4>
                            <h6 class="card-title">What is shown?</h6>
                            <p>
                                The visualization above shows every publication embedded in a 3D space where the
                                position determines
                                the topic of the publication. This means that papers that deal with the same topic are
                                closer together than others.
                            </p>

                            <h6 class="card-title">How to navigate?</h6>
                            <p>
                                It is possible to navigate with the mouse and pan with the arrow keys.
                                The pan and zoom speed can be adjusted with the controls on the side to allow for more
                                fine
                                grained control.
                                By clicking on a paper, it and its ten closest neighbors are highlighted and displayed
                                in a
                                list below ordered by the distance from the selected paper. It is also possible to click
                                on
                                a topic
                                to highlight
                            </p>

                            <h6 class="card-title">What is the purpose?</h6>
                            <p></p>

                            <h6 class="card-title">How are the embeddings generated?</h6>

                            <p>We trained a neural network (a BERT transformer model) given a title and an
                                abstract from a publication to predict if they are from the same publication or not.
                                By randomly exchanging some title and abstracts during training,
                                the network has to learn what the papers are about to be good at the prediction.
                                It can then generate a 512 dimensional encoding of every publication.
                                To visualize these generated embeddings, we reduced the dimensionality of each vector
                                with T-SNE to a three dimensional space.
                            </p>

                            <h6 class="card-title">How are the topics generated?</h6>
                            <p>To generate the different topics on the left side, we clustered the embeddings and then
                                assigned a name to the topic that in our opinion best reflects the contents of the
                                contained
                                papers.</p>

                        </div>
                    </div>
                </div>
            </div>
            <div class="flex-fill" style="min-width: 0">
                <div class="float-left ml-3 position-absolute">
                    <button id="show-info-btn" type="button"
                            class="btn btn-outline-secondary"
                            data-toggle="collapse"
                            data-target="#description-container"
                            aria-expanded="true"
                            aria-controls="description-container">
                        <i class="fa fa-info-circle"></i>
                        Show Info
                    </button>
                </div>
                <div class="row mr-0 ml-0 justify-content-center">
                    <div class="mb-2 col-md-6" style="max-width: 400px;">
                        <div class="input-group" style="border-radius: 2rem;">
                            <div class="input-group-prepend">
                                    <span class="input-group-text" id="filter-prepend"><i
                                            class="fas fa-search text-body"></i></span>
                            </div>
                            <input type="text" class="form-control" id="topic-filter-input"
                                   placeholder="Filter Topics" aria-describedby="filter-prepend"
                                   required>
                        </div>
                    </div>
                </div>

                <!--end of col-->
                <div class="row mr-0 ml-2">

                    <ul class="list-group mt-2 w-100">

                        {% for topic in topics %}
                            <li class="list-group-item topic-card" data-topic-name="{{ topic.name }}"
                                data-topic="{{ topic.pk }}">


                                <h6>{{ topic.name }}</h6>

                                <div class="mt-2 small">
                                    <a href="{% url "search" %}?topics={{ topic.pk }}" class="float-right">View all
                                        papers</a>

                                    <div class="text-muted">
                                        {{ topic.papers.count }} Papers
                                    </div>


                                </div>

                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}
    {% javascript 'embedding-visualization' %}
    <script>
        const topics = JSON.parse("{{ topic_dict | escapejs }}");
        const colors = JSON.parse("{{ category_colors | escapejs }}");

        const canvas = document.getElementById('visualization-container');
        const selectedCardContainer = $('#selected-card-container');
        const visualization = new EmbeddingVisualization();
        const topicsContainer = $('#topics-container');
        const paperLoadingIndicator = $('#paper-loading-indicator');
        const topicLegend = $('#topic-legend');
        const topicLabel = $('#topic-label');
        const categoryLegend = $('#category-legend');
        const paperSelectedLegend = $('#paper-selected-legend');
        const topicFilterInput = $('#topic-filter-input');
        const descriptionContainer = $('#description-container');
        const showInfoButton = $('#show-info-btn');
        const topicCardContainer = $('.topic-card-container');

        descriptionContainer.on('show.bs.collapse', function () {
            showInfoButton.hide();
        });
        descriptionContainer.on('hidden.bs.collapse', function () {
            showInfoButton.fadeIn();
        });

        function toggleTopicsContainer(show) {
            if (show) {
                topicsContainer.addClass('d-flex');
                topicsContainer.removeClass('d-none');
            } else {
                topicsContainer.addClass('d-none');
                topicsContainer.removeClass('d-flex');
            }
        }

        topicFilterInput.on('input', function (e) {
            const query = topicFilterInput.val();
            $('.topic-card').each(function (i) {
                const element = $(this);
                let topicName = element.data('topic-name').toLowerCase();
                if (topicName.includes(query.toLowerCase()) || query.trim() === "") {
                    element.show()
                } else {
                    element.hide()
                }
            })
        });

        const zoomSlider = $("#zoom-slider").slider();
        zoomSlider.on('slide', function (e) {
            visualization.controls.zoomSpeed = e.value;
            visualization.controls.update();
        });

        const panSlider = $("#pan-slider").slider();
        panSlider.on('slide', function (e) {
            visualization.controls.panSpeed = e.value;
            visualization.controls.update();
        });

        function onSelected(idx, paper) {
            paperLoadingIndicator.show();
            selectedCardContainer.hide();
            toggleTopicsContainer(false);

            const indices = visualization.computeNeighbors(paper, 10);
            const dois = [paper.doi];
            indices.forEach((i) => {
                dois.push(visualization.papers[i].doi)
            });
            visualization.selectPaper(idx, indices);

            $.get('/paper-cards/', {
                'dois': JSON.stringify(dois)
            }, function (data) {
                selectedCardContainer.html(data);
                paperLoadingIndicator.hide();
                selectedCardContainer.show();
                paperSelectedLegend.show();
                categoryLegend.hide();
                topicLegend.hide();
            })
        }

        visualization.renderEmbeddings(canvas, onSelected, {
                'imageUrl': '{{ atlas_image_url }}',
                'fileUrl': '{{ paper_file_url }}',
                'categoryColors': colors,
                'zoomSpeed': 0.25,
                'panSpeed': 0.5
            }
        );

        visualization.onDeselect(function () {
            selectedCardContainer.hide();
            toggleTopicsContainer(true);
            categoryLegend.show();
            paperSelectedLegend.hide();
            topicLegend.hide();
        });

        $('.topic-card').on('click', function (e) {
            const topicCard = $(e.target).closest('.topic-card');
            const topicId = topicCard.data('topic');
            const paperIds = topics[topicId];
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
            topicLabel.text(topicCard.data('topic-name'));
            topicLegend.show();
            categoryLegend.hide();
            paperSelectedLegend.hide();
            visualization.selectPapers(paperIds, 0xffffff);
        });

        $('.category-label').on('click', function (e) {
            let categoryId = $(e.target).closest('.category-label').data('category');
            let dois = [];
            visualization.papers.forEach(function (paper) {
                let category = visualization.getHighestCategoryForPaper(paper)
                if (category === categoryId) {
                    dois.push(paper.doi);
                }
            });
            visualization.selectPapers(dois, colors[categoryId]);
            categoryLegend.show();
            paperSelectedLegend.hide();
            topicLegend.hide();
        })

    </script>
{% endblock %}

{% block css %}
    {% stylesheet 'embedding_visualization' %}
    <style>
        #visualization-container {
            height: 100%;
            width: 100%;
            outline: none !important;
            border: none !important;
        }

        .canvas-adaptive-height {
            height: 60vh;
        }

        #visualization-container:focus {
            border: none !important;
        }

        @media (min-width: 991px) {
            /*#description-container {
                display: block;
            }*/
        }

        #description-container.collapsing {
            -webkit-transition-property: width, visibility;
            transition-property: width, visibility;
            transition-duration: .5s;
            -webkit-transition-duration: .5s;
            height: auto;
            width: 0;
            opacity: 1;
        }

        #canvas-container {
            top: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        #canvas-container canvas {
            z-index: 0;
        }

        .topic-card {
            user-select: none;
        }

        .slider .slider-handle {
            background: #abad9f;
        }

        .badge {
            user-select: none;
        }

        .sidebar {
            position: absolute;
            bottom: 0;
            margin-top: 20px;
            width: 100%;
            max-width: 100%;
            left: 0;
        }

        .sidebar .badges .legend div {
            display: flex;
            flex-direction: row;
            justify-content: center;
            flex-wrap: wrap;
        }

        .sidebar .badges .legend div div {
            max-width: 100%;
        }

        .sidebar .badges .legend div div span.badge {
            white-space: normal !important;
            margin: 0.5em;
        }

        @media (min-width: 768px) {
            .sidebar {
                left: 0;
                flex-direction: column;
                margin-left: 1.5em;
                margin-top: 0;
                top: 0;
                display: flex;
                width: auto;
            }

            .sidebar .badges {
                align-content: flex-end;
            }

            .sidebar .badges .legend div {
                display: block;

            }

            .sidebar .badges .legend div div {
                padding: 0;
            }
        }

        #selected-card-container {
        }
    </style>
{% endblock %}