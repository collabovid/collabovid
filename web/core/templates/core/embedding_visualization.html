{% extends "core/base.html" %}
{% load static %}
{% load pipeline %}
{% load paper_card_extras %}

{% block content %}
    {% include "core/partials/embedding/_help.html" %}

    <div class="gradient-header pb-0 overflow-hidden">
        <div class="row mx-0 px-0">
            <div class="col-12 px-0">
                <div id="embedding-visualization-container" class="embedding-visualization-container">
                    <div class="canvas-adaptive-height">
                        <div id="canvas-container">
                            <canvas id="visualization-container"></canvas>
                        </div>
                    </div>

                    <div class="canvas-controls">
                        <div class="flex-container d-flex flex-row">
                            <div class="text-white d-none d-md-block mr-2">
                                <div id="zoom-pan-controls">
                                    <div>
                                        <div class="">Zoom Speed</div>
                                        <input id="zoom-slider" class="slider" type="text" data-slider-min="0.01"
                                               data-slider-max="1" data-slider-step="0.01" data-slider-value="0.25"/>
                                    </div>
                                    <div class="mt-2">
                                        <div class="">Pan Speed</div>
                                        <input id="pan-slider" class="slider" type="text" data-slider-min="0.01"
                                               data-slider-max="1" data-slider-step="0.01" data-slider-value="0.5"/>
                                    </div>
                                </div>
                            </div>

                            <div class="message-controls flex-fill text-center mr-2">
                                <div id="paper-selected-message"
                                     class="bg-dark p-2 rounded text-white">
                                    <div class="full-screen-visible">
                                        Details about the selected paper can be found at the bottom
                                        of the page once you exit the full screen.
                                    </div>
                                    <div class="full-screen-hidden">The paper is loading and will be shown below.</div>
                                </div>
                            </div>

                            <div class="text-right">
                                <button class="btn btn-outline-light"
                                        data-toggle="modal"
                                        data-target="#help-modal">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                <button class="btn btn-outline-light full-screen-toggle">
                                    <i class="fas fa-expand-alt"></i>
                                </button>
                                <button class="btn btn-outline-light full-screen-toggle" style="display: none;">
                                    <i class="fas fa-compress-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="legend">
                        <div>
                            <div id="category-legend">
                                {% for category in categories %}
                                    <div class="category-label"
                                         data-category="{{ category.name }}"
                                         data-category-id="{{ category.pk }}">
                                        <span id="{{ category.pk }}-badge" class="category-badge badge"
                                              data-background-color="{{ category.color }}"
                                              style="background-color: {{ category.color }}">
                                            {{ category.name }}
                                        </span>
                                    </div>
                                {% endfor %}
                            </div>
                            <div id="topic-legend" style="display: none">
                                <div>
                                    <span id="topic-label" class="badge badge-light"></span>
                                </div>
                            </div>
                            <div id="paper-selected-legend" style="display: none">
                                <div>
                                <span class="badge badge-primary"
                                      style="background-color: #ffc266">
                                    Selected Paper
                                </span>
                                </div>
                                <div>
                                <span class="badge badge-primary"
                                      style="background-color: #cc7a00">
                                    Most similar papers
                                </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% include 'core/partials/_rounded_bottom.html' %}
    </div>
    <div id="paper-loading-indicator"
         class="text-muted text-center fa-5x my-5"
         style="display: none;">
        <i class="fas fa-circle-notch fa-spin"></i>
    </div>
    <div class="container">
        <div class="mt-3" id="selected-card-container" style="display: none;"></div>
    </div>
    <div class="container">
        <div id="topics-container">
            <div class="row">
                <div class="col-12 col-md-3 text-left mt-2">
                    <button type="button"
                            class="btn btn-outline-secondary"
                            id="help-modal-label"
                            data-toggle="modal"
                            data-target="#help-modal">
                        <i class="fa fa-info-circle"></i>
                        Show Info
                    </button>
                </div>

                <div class="mb-2 col-12 col-md-6 mt-2">
                    <div class="input-group mx-auto" style="border-radius: 2rem;">
                        <div class="input-group-prepend">
                            <span class="input-group-text"
                                  id="filter-prepend">
                                <i class="fas fa-search text-body"></i>
                            </span>
                        </div>
                        <input type="text"
                               class="form-control"
                               id="topic-filter-input"
                               placeholder="Filter Topics"
                               aria-describedby="filter-prepend"
                               required>
                    </div>
                </div>
            </div>

            <div class="row mt-2">
                <div class="col-12">
                    <ul class="list-group w-100">
                        {% for topic in topics %}
                            <li class="list-group-item topic-item" data-topic-name="{{ topic.name }}"
                                data-topic="{{ topic.pk }}">
                                <div class="d-flex flex-row align-items-stretch">
                                    <div>
                                        <button class="btn btn-info h-100 show-topic">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="flex-fill pl-3">
                                        <h6 class="show-topic d-inline-block mb-0"
                                            style="cursor: pointer;">{{ topic.name }}</h6>
                                        <div class="mt-1 small">
                                            <a href="{% url "search" %}?topics={{ topic.pk }}" class="float-right">
                                                View all papers
                                            </a>
                                            <div class="text-muted">
                                                {{ topic.papers.count }} Papers
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}
    {% javascript 'embedding-visualization' %}
    <script>
        window.visualizationEventRunning = false;
        window.justUsedTouchControls = false;
        window.oldPanSpeed = 0;
        window.oldZoomSpeed = 0;

        const topics = JSON.parse("{{ topic_dict | escapejs }}");
        const colors = JSON.parse("{{ category_colors | escapejs }}");

        const canvas = document.getElementById('visualization-container');
        const selectedCardContainer = $('#selected-card-container');
        const visualization = new EmbeddingVisualization();
        const topicsContainer = $('#topics-container');
        const paperLoadingIndicator = $('#paper-loading-indicator');
        const topicLegend = $('#topic-legend');
        const topicLabel = $('#topic-label');
        const categoryLegend = $('#category-legend');
        const paperSelectedLegend = $('#paper-selected-legend');
        const topicFilterInput = $('#topic-filter-input');
        const descriptionContainer = $('#description-container');
        const showInfoButton = $('#show-info-btn');
        const topicCardContainer = $('.topic-card-container');
        const fullScreenToggleBtn = $(".full-screen-toggle");
        const embeddingVisualizationContainer = $("#embedding-visualization-container");
        const paperSelectedMessage = $("#paper-selected-message");
        const zoomPanControls = $("#zoom-pan-controls");

        fullScreenToggleBtn.click(function (e) {
            e.preventDefault();
            embeddingVisualizationContainer.toggleClass('full-screen');
            fullScreenToggleBtn.toggle();
            visualization.refreshSize();
        });

        topicFilterInput.on('input', function (e) {
            const query = topicFilterInput.val();
            $('.topic-item').each(function (i) {
                const element = $(this);
                let topicName = element.data('topic-name').toLowerCase();
                if (topicName.includes(query.toLowerCase()) || query.trim() === "") {
                    element.show()
                } else {
                    element.hide()
                }
            })
        });

        const zoomSlider = $("#zoom-slider").slider();
        zoomSlider.on('slide', function (e) {
            visualization.controls.zoomSpeed = e.value;
            visualization.controls.update();
        });

        const panSlider = $("#pan-slider").slider();
        panSlider.on('slide', function (e) {
            visualization.controls.panSpeed = e.value;
            visualization.controls.update();
        });

        function onSelected(idx, paper) {
            if (window.visualizationEventRunning) {
                return;
            }

            window.visualizationEventRunning = true;
            paperLoadingIndicator.show();
            selectedCardContainer.hide();
            topicsContainer.hide();
            categoryLegend.hide();
            topicLegend.hide();

            paperSelectedMessage.stop().animate({"opacity": 1}, 500, function () {
                paperSelectedMessage.stop().animate({"null": 1}, 4000, function () {
                    paperSelectedMessage.stop().animate({"opacity": 0}, 500);
                });
            });


            const indices = visualization.computeNeighbors(paper, 10);
            const dois = [paper.doi];
            indices.forEach((i) => {
                dois.push(visualization.papers[i].doi)
            });
            visualization.selectPaper(idx, indices);

            $.get('/paper-cards/', {
                'dois': JSON.stringify(dois)
            }, function (data) {
                selectedCardContainer.html(data);
                paperLoadingIndicator.hide();
                selectedCardContainer.show();
                paperSelectedLegend.show();
                window.visualizationEventRunning = false;
            });
        }

        visualization.renderEmbeddings(canvas, onSelected, {
                'imageUrl': '{{ atlas_image_url }}',
                'fileUrl': '{{ paper_file_url }}',
                'categoryColors': colors,
                'zoomSpeed': 0.25,
                'panSpeed': 0.5
            }
        );

        visualization.onTouch(function () {

            if (!window.justUsedTouchControls) {
                zoomPanControls.hide();

                window.justUsedTouchControls = true;
                window.oldPanSpeed = visualization.controls.panSpeed;
                window.oldZoomSpeed = visualization.controls.zoomSpeed;

                visualization.controls.panSpeed = 0.1;
                visualization.controls.zoomSpeed = 0.1;
            }

        });

        visualization.onMouseClick(function () {

            if (window.justUsedTouchControls) {
                zoomPanControls.show();
                window.justUsedTouchControls = false;

                visualization.controls.panSpeed = window.oldPanSpeed;
                visualization.controls.zoomSpeed = window.oldZoomSpeed;
            }
        });

        visualization.onDeselect(function () {
            if (window.visualizationEventRunning) {
                return;
            }

            window.visualizationEventRunning = true;
            selectedCardContainer.hide();
            topicsContainer.show();
            categoryLegend.show();
            paperSelectedLegend.hide();
            topicLegend.hide();

            $(".category-badge").each(function () {
                $(this).removeClass('badge-secondary').css('background-color', $(this).data('background-color'));
            });

            window.visualizationEventRunning = false;
        });

        $('.topic-item .show-topic').on('click', function (e) {
            if (window.visualizationEventRunning) {
                return;
            }

            window.visualizationEventRunning = true;

            const topicItem = $(e.target).closest('.topic-item');
            const topicId = topicItem.data('topic');
            const paperIds = new Set(topics[topicId]);
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
            topicLabel.text(topicItem.data('topic-name'));
            topicLegend.show();
            categoryLegend.hide();
            paperSelectedLegend.hide();
            visualization.selectPapers(paperIds, 0xffffff);

            window.visualizationEventRunning = false;
        });

        $('.category-label').on('click', function (e) {
            console.log(window.visualizationEventRunning);

            if (window.visualizationEventRunning) {
                return;
            }

            window.visualizationEventRunning = true;
            let categoryName = $(this).data('category');
            let categoryId = $(this).data('category-id');
            let categroyBadge = $("#" + categoryId + "-badge");

            $(".category-badge:not(#" + categoryId + "-badge)").css('background-color', '#6c757d');
            categroyBadge.css('background-color', categroyBadge.data('background-color'));

            let dois = new Set();
            visualization.papers.forEach(function (paper) {
                let category = visualization.getHighestCategoryForPaper(paper);
                if (category === categoryName) {
                    dois.add(paper.doi);
                }
            });
            visualization.selectPapers(dois, colors[categoryName]);
            categoryLegend.show();
            paperSelectedLegend.hide();
            topicLegend.hide();
            window.visualizationEventRunning = false;
        })

    </script>
{% endblock %}

{% block css %}
    {% stylesheet 'embedding_visualization' %}
    <style>

        span.category-badge:not(.badge-secondary) {
            color: #ffffff;
        }

        div.embedding-visualization-container .canvas-controls {
            position: absolute;
            top: 0;
            left: .5rem;
            right: .5rem;
            pointer-events: none;
        }

        div.embedding-visualization-container .canvas-controls button, div.embedding-visualization-container .canvas-controls .slider {
            pointer-events: all;
        }

        div.embedding-visualization-container .canvas-controls .flex-container > div:last-of-type {
            white-space: nowrap
        }

        @media (min-width: 576px) {
            div.embedding-visualization-container .canvas-controls .flex-container > div:first-of-type,
            div.embedding-visualization-container .canvas-controls .flex-container > div:last-of-type {
                width: 20%;
            }
        }

        div.message-controls > div {
            display: inline-block;
            opacity: 0;
        }

        div.embedding-visualization-container .canvas-adaptive-height #visualization-container {
            height: 100%;
            width: 100%;
            outline: none !important;
            border: none !important;
        }

        div.embedding-visualization-container .canvas-adaptive-height {
            height: 60vh;
        }

        div.embedding-visualization-container .canvas-adaptive-height #visualization-container:focus {
            border: none !important;
        }

        div.embedding-visualization-container .canvas-adaptive-height #canvas-container {
            width: 100%;
            height: 100%;
        }

        div.embedding-visualization-container.full-screen {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background-color: #75a5f2;
            background-image: linear-gradient(135deg, #75A5F2 0%, #5475a1 100%);
            z-index: 999;
        }

        div.embedding-visualization-container.full-screen .full-screen-hidden,
        div.embedding-visualization-container:not(.full-screen) .full-screen-visible {
            display: none;
        }

        div.embedding-visualization-container.full-screen div.canvas-controls {
            top: 20px;
        }

        div.embedding-visualization-container.full-screen div.canvas-adaptive-height {
            height: 100%;
        }


        .topic-item {
            user-select: none;
        }

        .slider.slider.slider-horizontal {
            width: 180px;
            max-width: 100%;
        }

        .slider .slider-handle {
            background: #abad9f;
            width: 15px;
            height: 15px;
            margin-left: -7.5px;
            top: 2.5px
        }

        .slider .slider-track {
            height: 6px !important;
            margin-top: -3px !important;
        }


        .badge {
            user-select: none;
        }

        .legend {
            position: absolute;

            bottom: 3rem;
            left: 0;

            width: 100%;
            max-width: 100%;
        }

        .legend > div {
            width: 100%;
            max-width: 100%;
        }

        @media (max-width: 992px) {
            .legend {
                bottom: 0;
            }
        }

        .legend > div > div {
            width: 100%;
            max-width: 100%;
            display: flex;
            flex-direction: row;
            justify-content: center;
            flex-wrap: wrap;
            flex-grow: 1;
        }

        .legend span.badge {
            white-space: normal !important;
            margin: 0.5em;
        }


        #selected-card-container {
        }
    </style>
{% endblock %}