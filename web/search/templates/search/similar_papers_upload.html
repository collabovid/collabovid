{% extends "core/base.html" %}
{% load static %}
{% load pipeline %}
{% block content %}

    <div class="gradient-header pb-5">
        <div class="container">
            <div class="row mt-5 mb-5">
                <div class="col-12">

                    <h1 class="text-white display-4">Upload your literature</h1>

                    <div class="muted-white">
                        You can upload your existing literature files to find COVID-19 publications which are
                        <strong>similar</strong> to your favorite articles. The data you upload will be processed
                        in order to identify articles which we have in our database. Afterwards the uploaded file
                        will be deleted permanently from our servers.
                        For the articles which are in our database, we provide a similarity search function that
                        allows you find similar articles for your query. Upload your literature as a
                        <strong>.ris</strong> file and try it out!
                    </div>

                    <form class="mt-5 mr-5 ml-5" id="upload-form" action="{% url "upload_ris" %}" method="post"
                          enctype="multipart/form-data">

                        {% csrf_token %}
                        <input type="file" name="file" id="literature-file" style="display: none;"/>

                        <div role="button" class="upload-area rounded">
                            <div class="icon default">
                                <i class="fas fa-file-upload fa-4x"></i>
                            </div>
                            <div class="icon drag" style="display: none;">
                                <i class="fas fa-4x fa-hand-point-down"></i>
                            </div>
                            <div class="icon indicator" style="display: none;">
                                <i class="fas fa-4x fa-circle-notch fa-spin"></i>
                            </div>
                            <div class="icon success" style="display: none;">
                                <i class="fas fa-4x fa-check-circle"></i>
                            </div>
                            <h4 class="font-weight-light text-center"
                                data-text-default="Upload your file"
                                data-text-dragging="Drag here"
                                data-text-dragover="Drop it!"
                                data-text-uploading="Uploading..."
                                data-text-success="Your file was analyzed. Check the results below."
                            >Upload your file</h4>
                        </div>

                    </form>

                </div>

            </div>

        </div>

        {% include 'core/partials/_rounded_bottom.html' %}

    </div>


    <div class="container mt-5">
        <div id="analysis-container"></div>
    </div>

{% endblock %}

{% block script %}

    <script>
        $(document).ready(function () {
            let html = $("html");
            let upload_form = $("#upload-form");
            let upload_area = $(".upload-area");
            let upload_area_text = $(".upload-area h4");

            let drag_icon = $(".upload-area .icon.drag");
            let default_icon = $(".upload-area .icon.default");
            let indicator_icon = $(".upload-area .icon.indicator");
            let success_icon = $(".upload-area .icon.success");

            let icons = $(".upload-area .icon");
            let file_field = $("#literature-file");

            let analysis_container = $("#analysis-container");


            // preventing page from redirecting
            html.on("dragover", function (e) {
                e.preventDefault();
                e.stopPropagation();
                upload_area_text.text(upload_area_text.data('text-dragging'));
                icons.hide();
                drag_icon.show();
            });

            html.on("drop", function (e) {
                e.preventDefault();
                e.stopPropagation();

                upload_area_text.text(upload_area_text.data('text-default'));
                icons.hide();
                default_icon.show();
            });

            // Drag enter
            upload_area.on('dragenter', function (e) {
                e.stopPropagation();
                e.preventDefault();
                upload_area_text.text(upload_area_text.data('text-dragover'));
            });

            // Drag over
            upload_area.on('dragover', function (e) {
                e.stopPropagation();
                e.preventDefault();
                upload_area_text.text(upload_area_text.data('text-dragover'));
            });

            // Drop
            upload_area.on('drop', function (e) {
                e.stopPropagation();
                e.preventDefault();


                file_field.prop('files', e.originalEvent.dataTransfer.files);

                uploadData(e.originalEvent.dataTransfer.files[0])

            });

            upload_area.click(function (e) {
                e.preventDefault();
                file_field.click();
            });

            file_field.change(function (e) {
                uploadData(file_field.prop('files')[0]);
            });

            function uploadData(file) {

                let form_data = new FormData();

                form_data.append('file', file);
                form_data.append('csrfmiddlewaretoken', upload_form.children('input[name=csrfmiddlewaretoken]').val());

                for (var p of form_data) {
                    console.log(p);
                }

                icons.hide();
                indicator_icon.show();
                upload_area.addClass('uploaded');
                upload_area_text.text(upload_area_text.data('text-uploading'));


                $.ajax({
                    url: upload_form.attr('action'),
                    type: 'post',
                    data: form_data,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        analysis_container.html(data);
                        console.log("here");

                        icons.hide();
                        success_icon.show();
                        upload_area_text.text(upload_area_text.data('text-success'));

                    },
                    error: function (request, error) {
                        console.log("Request: " + JSON.stringify(request));
                        console.log("Error: " + error);
                    }
                });
            }
        });
    </script>
{% endblock %}

{% block css %}
    <style>
        .upload-area {
            width: 100%;
            height: 200px;
            background: rgba(0.8, 0.8, 0.8, 0.2);
            border-radius: 10px;
            position: relative;
            color: #e0e0e0;

            -webkit-transition: background-color 1s;
            transition: background-color 1s;

            -webkit-box-shadow: 0px 0px 17px 0px rgba(0, 0, 0, 0.75);
            -moz-box-shadow: 0px 0px 17px 0px rgba(0, 0, 0, 0.75);
            box-shadow: 0px 0px 17px 0px rgba(0, 0, 0, 0.75);

        }

        .upload-area:after {
            border-radius: 10px;
            padding: 5px;
            border: 5px dashed #e0e0e0;

            position: absolute;
            content: '';
            top: -5px;
            left: -5px;
            bottom: -5px;
            right: -5px;
        }

        .upload-area.uploaded, .upload-area.uploaded:after {
            border: none;
            background: none;

            -webkit-box-shadow: 0 0 0 0;
            -moz-box-shadow: 0 0 0 0;
            box-shadow: 0 0 0 0;
        }

        .upload-area div {
            height: 80px;
            text-align: center;
            padding-top: 30px;
        }

        .upload-area h4 {
            line-height: 120px;
            margin-bottom: 0;
        }
    </style>
{% endblock %}