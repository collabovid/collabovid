{% extends "core/base.html" %}
{% load static %}
{% load pipeline %}
{% block content %}

    <div class="gradient-header pb-5">
        <div class="container">
            <div class="row mt-5 mb-5">
                <div class="col-12">

                    <h1 class="display-4">Upload your literature</h1>

                    <div class="muted-white">
                        We provide
                    </div>

                    <form id="upload-form" action="{% url "upload_ris" %}" method="post"
                          enctype="multipart/form-data">

                        {% csrf_token %}
                        <input type="file" name="file" id="literature-file" style="display: none;"/>

                        <div role="button" class="upload-area shadow rounded">
                            <div><i class="fas fa-file-upload fa-4x"></i></div>
                            <h4 class="font-weight-light text-center">Upload your file</h4>
                        </div>

                    </form>

                </div>

            </div>

        </div>

        {% include 'core/partials/_rounded_bottom.html' %}

    </div>


    <div class="container mt-5">
        <div id="analysis-container"></div>
    </div>

{% endblock %}

{% block script %}

    <script>
        $(document).ready(function () {
            let html = $("html");
            let upload_form = $("#upload-form");
            let upload_area = $(".upload-area");
            let upload_area_text = $(".upload-area h4");
            let file_field = $("#literature-file");

            let analysis_container = $("#analysis-container");


            // preventing page from redirecting
            html.on("dragover", function (e) {
                e.preventDefault();
                e.stopPropagation();
                upload_area_text.text("Drag here");
            });

            html.on("drop", function (e) {
                e.preventDefault();
                e.stopPropagation();
            });

            // Drag enter
            upload_area.on('dragenter', function (e) {
                e.stopPropagation();
                e.preventDefault();
                upload_area_text.text("Drop");
            });

            // Drag over
            upload_area.on('dragover', function (e) {
                e.stopPropagation();
                e.preventDefault();
                upload_area_text.text("Drop");
            });

            // Drop
            upload_area.on('drop', function (e) {
                e.stopPropagation();
                e.preventDefault();

                upload_area_text.text("Upload");


                file_field.prop('files', e.originalEvent.dataTransfer.files);

                uploadData(e.originalEvent.dataTransfer.files[0])

            });

            upload_area.click(function (e) {
                e.preventDefault();
                file_field.click();
            });

            file_field.change(function (e) {
                uploadData(file_field.prop('files')[0]);
            });

            function uploadData(file) {

                let form_data = new FormData();

                form_data.append('file', file);
                form_data.append('csrfmiddlewaretoken', upload_form.children('input[name=csrfmiddlewaretoken]').val());

                for (var p of form_data) {
                    console.log(p);
                }

                $.ajax({
                    url: upload_form.attr('action'),
                    type: 'post',
                    data: form_data,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        analysis_container.html(data);
                        console.log("here")
                    },
                    error: function (request, error) {
                        console.log("Request: " + JSON.stringify(request));
                        console.log("Error: " + error);
                    }
                });
            }
        });
    </script>
{% endblock %}

{% block css %}
    <style>
        .upload-area {
            width: 100%;
            height: 200px;
            background: rgba(0.8, 0.8, 0.8, 0.2);
            border-radius: 10px;
            position: relative;
            color: #e0e0e0;
        }

        .upload-area:after {
            border-radius: 10px;
            padding: 5px;
            border: 5px dashed #e0e0e0;

            position: absolute;
            content: '';
            top: -5px;
            left: -5px;
            bottom: -5px;
            right: -5px;
        }

        .upload-area div {
            height: 80px;
            text-align: center;
            padding-top: 30px;
        }

        .upload-area h4 {
            line-height: 120px;
            margin-bottom: 0;
        }
    </style>
{% endblock %}